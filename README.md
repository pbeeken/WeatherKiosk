# Weather Kiosk
This is an experiment to build a tide/weather viewer for a specific location using a Raspberry Pi connected to an old display.
The display will be encased in a weatherproof box an mounted outside a boatyard office. (Assuming everything else goes well)

## Beginnings
This started out as a quick and dirty experiment with a little used older model RasPi B model that I had gotten for a different purpose.
I had an old monitor with a DVI input which I could cheaply adapt to HDMI.  We had a mechanical tide clock that was never accurate at a boat
club where I teach sailing and thought, there has to be a better system.  Discovering that tide information is readily available from NOAA I
decided to give it a try.  I could always fall back on harmonic parameters (also available from NOAA) if the source became unavailable.

This is a complete refactoring of the original design. I learned a lot about html5 layouts and how to to keep screens from blinking and such.

## Methods
Being very comfortable with python, matplotlib, numpy and a desire to learn how to make effective use of pandas dataframes I figured I could
grab the data with a short program, build a graph (.png) and use a web browser to arrange and display the results. I do these projects for the learning experience as much as for anything else.  I didn't want to just pull the data from the website because there is s a bunch of other graphics and materials I didn't want cluttering the screen.  It went so successfully I started to expand the project.

## Considerations
I use a web page that self updates and thus picks up any changes to the graphics.  Once I got the tide part working I realized I had a lot more screen real estate and wanted to provide other useful tidbits.  There are nearby weather buoys which record wind and, in some case, wave information.  The national weather service provides a very elegant REST interface to fetch forcast information, although at the time of this writing no marine forcasts as of yet.  Being a club mostly devoted to stick and rag people this is nice to have to remind people of what conditions are like outside the sheltered cove where we sit.

Another important part to make this project a reality is to turn the whole machine into a 'kiosk' that can be reset by simply turning it off and then on again. This part turned out not to be as straightforward as I originally thought.  It took me a day to get the details right to pull this part of it together.

Finally is the building of a weatherproof case that allows the Pi to not get too hot. (Fortunately the wall where this is likely to be mounted is just inside a covered area out of direct weather.)  For me, this is the easy part.

## Making the Pi into a kiosk device
There is a [seperate document on this](RaspberryPiKiosk.md). There is a lot of helpful information out there but, really, every setup is different and each use case requires tinkering, experimentation and testing. After starting with a full copy of Raspbian and peeling away unneeded software, I downgraded to Raspian Lite and built up.  Because I am running python I needed to get a few important libraries installed that worked correctly on a RPi (*hint, don't use pip in this situation, matplotlib, numpy and pandas need to be built specifically for the arm processor*).  Could I have used node? Sure, but because I am gathering data from disparate sources and wanted the convenience of pandas' robust importing to read and formatting data I'm kinda forced along the python path.  I have since discovered that there is an effort to build a matplotlib type library in ts.  I was even able to write a simple caching tool so I wouldn't be rude to the NWS and NOAA servers.  In short: not a learning curve I wanted to go up right now.

## Some of the tools I needed to build
While I had some familiarity with html from back in the days where all pages were built by hand, the huge addition of new tags and 'best practices' of how to set up css was new.  The idea was to let the html do the layout while asynchronous background processes kept the graphics up to date. The main processes that I planed to have running:

  - `TidesGraph.py` : generates a huge graph similar to the one generated by NOAA. I liked the overall layout but I wanted to make my own so I could customize the display. Since it is a "clock" I run this about once every five minutes. I cache the data once per day since the update only looks out about 2 days.  Oddly enough this is actually important near the target location as different boats where work has to be done aloft can time their repairs to the time of the tide.  For some kinds of work you can pull the boat alongside a tower and access the place you need to go.
  - `TidesGraphic.py` : generates a cartoon of the tide level with an arrow that shows the current direction of the tide.  Only needs to be updated once evey 30min or so.
  - `TidesTable.py` : builds a table of the next 4 tide extrema for easy reference.  I use css to format it nicely for the screen
  - `Winds.py` : generates a wind graph of average and max wind for display. It is run about once every 15 minutes. Since the download is just a csv file it doesn't hammer too much. The tricky part here is that the buoy data can be unreliable. There are blank spots that have to be filtered, sometimes there is nothing at all so I had to devise a scheme to fall back to more reliable but not necessarily proximate sources to populate the chart.
  - `Forcast.py` : work in progress.  Right now I grab land information using the inagurated REST calls once an hour but what I want is are the nice marine forcast graphics that I can get in a web page.
  - `tidedata.py` : the home of a library of routines used by the above generators.
  - `chromium-browser` with a whole bunch of command line settings to run in a kiosk mode (a minimal Xwindows framework has to be installed, of course)

Because this is a kiosk I don't want to have to manage potential issues with handling and massaging data sets so I launch the above routines using a crontab as independent services. This way I don't have to deal with any potential leaks or other long term oddities that might crop up. Just restart the process.  The only available 'fix' if something should go wrong (power glitch or whatever) is to unplug the box and re-plug it in.

## Newer Addition
I have added a routine to fetch timing data from the US Naval Observatory.  Because of a CORS hiccup I have made pything cgi routines to perform the data fetch. What I will do is what I have done for the tide data and cache the result every day reduce any demands on the USNO server. I only need fetch this informaion once per day.  PS ProTip: when setting up your cgi-bin don't forget to set the executable bit.  DUUHHH.

## TODO:
 - ~~I would like to have the screen shut down in the evening and start up at around dawn. I might even want it to turn off and turn on based on an external clock?  This may require some electronic tinkering.~~ **Done** a cron job shuts the processor down. When the video stops the monitor goes into a very low power state (works for this situation).  The next morning the harbormaster just cycles the power button and all things begin a fresh.
 - ~~Explore some hidden ways to put error messages into the screen, display some icons in discrete locations that indicate the health of the system.~~ **Done** _to some extent._ There are subtle messages and formatting changes that get made when something is amiss. As mentioned above, the fix is to simply unplug and replug it in.  So far the multiday burn-in tests have shown no unexpected behavior.
 - ~~The moon image is ugly. I grabbed some jpgs from a website that look OK when viewed at full resolution but don't look good when rendered.  Solution is to build an svg cartoon to display.~~ **Done** I draw the cartoon using matplotlib and export as an svg. I can control the size and shape precisely and it scales to whatever size I want.

## Additional notes

 - `README.md` : This overview
 - `RaspberryPiKiosk.md` : Work toward the kiosk setup
 - `WeatherTests.ipynb` : Jupyter Notebook with the experimentation on the data harvesting and presentation.

 Because there is an interaction between the cgi-bin, timed updates using cron and shell scripts there are a few moving parts that have to inderoperate. The bin/ folder contains the materials that need to run asynchronously with the web page kiosk to update the background information.  In addition there are crontab scripts that have to run as well.

## Moon
  Finally I built an background app (triggered by a cgi-bin request) to provide 3 moon 'lunes' to represent the current state of the moon to superimpose on the tide graph (for pure giggles.)  It pulls its information from the USNO who maintain a really equisite REST API.


# REEFACTOR 2022


## Refactoring 2022
The final device [tag](Working-V01) worked well the first summer and did exactly what I wanted. Another sailor asked the valid question as to why radar might not be on the screen.
While the original NOAA radar choked the poor little $\color{red}{Rasp} \Pi$ the new gif animation they released mid-summer 2022 worked perfectly.  So I figured out how to embed it in the page.

This, of course, led to a rethinking of the whole 'full stack' management of the various elements. Instead of carefully choreographing the action with crontab, cgi calls and such
why not control the whole thing through the web applications.

The hard layout work is done.  I need to

 - Since I a launch the browser on the pi with all the safeties off (it's a kiosk! No one is typing things in.) We can run scripts directly from the code on a schedule we set.
 - After setting up the frame we only need to toggle the visibility of the three &lt;div>&lt;/div> regions in the middle on a schedule.
 - This keeps the outer region (with a clock and a sunrise and sunset time) consitstent. I can even put easter eggs in the border area to flag the health of the system.

I created a branch from the main route with the tag `Working-V01` so I could get back to my original kuldgy system.  Now that I know what the final product should look like here is the overall plan.

  - At boot, the system will...
    - pull the latest changes from git `updateSystem.sh`.
    - move files where they need to be if not in the "kiosk" folder.
    - pre-load the initial graphics (all python programs).
    - launch the browser in kiosk mode.

  - During operations commands from the browser will periodically...
    - run the graphics commands to update images.
    - based on the day of the week, cycle through the information screens.

Much of the work will be relocating and consolidating the different codebits.
